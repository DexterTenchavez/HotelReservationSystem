@model IEnumerable<HotelReservationSystem.Models.Reservation>
@{
    ViewData["Title"] = "Admin Dashboard";
    Layout = "~/Views/Shared/_LayoutWithSidebar.cshtml";

    var activeReservations = Model.Where(r => r.Status != "Cancelled").ToList();
    var totalRevenue = activeReservations.Sum(r => r.TotalAmount);
    var totalReservations = activeReservations.Count();
    var averageGuests = activeReservations.Any() ? activeReservations.Average(r => r.NumberOfGuests) : 0;
    var uniqueGuests = activeReservations.Select(r => r.GuestName).Distinct().Count();

    var cancelledReservations = Model.Count(r => r.Status == "Cancelled");
    var cancellationRate = Model.Any() ? (decimal)cancelledReservations / Model.Count() * 100 : 0;

    var totalRooms = 18;
    var availableRooms = ViewBag.AvailableRooms ?? 0;
    var occupiedRooms = ViewBag.OccupiedRooms ?? 0;
    var maintenanceRooms = ViewBag.MaintenanceRooms ?? 0;

    var ratedReservations = Model.Where(r => r.Rating.HasValue).ToList();
    var totalRatings = ratedReservations.Count;
    var averageRating = totalRatings > 0 ? ratedReservations.Average(r => r.Rating.Value) : 0;
    var feedbackCount = Model.Count(r => !string.IsNullOrEmpty(r.Feedback));

    var paymentMethods = activeReservations
        .Where(r => !string.IsNullOrEmpty(r.PaymentMethod))
        .GroupBy(r => r.PaymentMethod)
        .Select(g => new { Method = g.Key, Count = g.Count(), Revenue = g.Sum(r => r.TotalAmount) })
        .OrderByDescending(x => x.Revenue)
        .ToList();

    var pendingPaymentCount = Model.Count(r => r.PaymentStatus == "Pending");
    var paidCount = Model.Count(r => r.PaymentStatus == "Paid");
    var failedPaymentCount = Model.Count(r => r.PaymentStatus == "Failed");

    var statusCounts = Model
        .GroupBy(r => r.Status)
        .Select(g => new { Status = g.Key, Count = g.Count() })
        .ToDictionary(x => x.Status, x => x.Count);
}

<div class="container-fluid">
    <div class="dashboard-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="text-white">
                    <i class="fas fa-tachometer-alt me-3"></i>Admin Dashboard
                </h1>
                <p class="text-white mb-0">Complete overview of hotel reservations and system analytics</p>
            </div>
            <div class="col-md-4 text-end">
                <div class="btn-group">
                    <a href="@Url.Action("RoomManagement", "Home")" class="btn btn-info btn-lg">
                        <i class="fas fa-door-open me-2"></i>Manage Rooms
                    </a>
                    <a href="@Url.Action("Index", "CashReceipts")" class="btn btn-success btn-lg">
                        <i class="fas fa-money-bill-wave me-2"></i>Transaction Station
                    </a>
                </div>
            </div>
        </div>
    </div>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle me-2"></i>@TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-circle me-2"></i>@TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stat-card border-left-primary">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="stat-card-label">Total Revenue</div>
                            <div class="stat-card-value">₱@totalRevenue.ToString("N2")</div>
                            <small class="text-muted">From active reservations</small>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-money-bill-wave stat-card-icon text-primary"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stat-card border-left-success">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="stat-card-label">Active Reservations</div>
                            <div class="stat-card-value">@totalReservations</div>
                            <small class="text-muted">Excluding cancelled</small>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-calendar-check stat-card-icon text-success"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stat-card border-left-warning">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="stat-card-label">Pending Payments</div>
                            <div class="stat-card-value">@pendingPaymentCount</div>
                            <small class="text-muted">Awaiting confirmation</small>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-clock stat-card-icon text-warning"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stat-card border-left-danger">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="stat-card-label">Cancellation Rate</div>
                            <div class="stat-card-value">@cancellationRate.ToString("F1")%</div>
                            <small class="text-muted">@cancelledReservations cancelled</small>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-times-circle stat-card-icon text-danger"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-info text-white">
                    <h6 class="m-0 font-weight-bold"><i class="fas fa-door-closed me-2"></i>Room Status Overview</h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-2 mb-3">
                            <div class="status-card">
                                <div class="status-value text-success">@availableRooms</div>
                                <div class="status-label">Available</div>
                                <small class="text-muted">Ready for guests</small>
                            </div>
                        </div>
                        <div class="col-md-2 mb-3">
                            <div class="status-card">
                                <div class="status-value text-primary">@occupiedRooms</div>
                                <div class="status-label">Occupied</div>
                                <small class="text-muted">Currently booked</small>
                            </div>
                        </div>
                        <div class="col-md-2 mb-3">
                            <div class="status-card">
                                <div class="status-value text-warning">@maintenanceRooms</div>
                                <div class="status-label">Maintenance</div>
                                <small class="text-muted">Under repair</small>
                            </div>
                        </div>
                        <div class="col-md-2 mb-3">
                            <div class="status-card">
                                <div class="status-value text-danger">@cancelledReservations</div>
                                <div class="status-label">Cancelled</div>
                                <small class="text-muted">This period</small>
                            </div>
                        </div>
                        <div class="col-md-2 mb-3">
                            <div class="status-card">
                                <div class="status-value text-warning">@pendingPaymentCount</div>
                                <div class="status-label">Pending Payment</div>
                                <small class="text-muted">Awaiting confirmation</small>
                            </div>
                        </div>
                        <div class="col-md-2 mb-3">
                            <div class="status-card">
                                <div class="status-value text-success">@paidCount</div>
                                <div class="status-label">Paid</div>
                                <small class="text-muted">Confirmed payments</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-light">
                    <h6 class="m-0 font-weight-bold text-dark">
                        <i class="fas fa-search me-2"></i>Search & Filter Reservations
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <div class="input-group">
                                <span class="input-group-text bg-primary text-white">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" id="searchInput" class="form-control" placeholder="Search by guest name, reservation no, room number...">
                                <button class="btn btn-outline-secondary" type="button" id="clearSearch">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>

                        <div class="col-md-2">
                            <select id="statusFilter" class="form-select">
                                <option value="all">All Status (@Model.Count())</option>
                                <option value="Confirmed">Confirmed (@(statusCounts.GetValueOrDefault("Confirmed", 0)))</option>
                                <option value="Checked-In">Checked-In (@(statusCounts.GetValueOrDefault("Checked-In", 0)))</option>
                                <option value="Completed">Completed (@(statusCounts.GetValueOrDefault("Completed", 0)))</option>
                                <option value="Cancelled">Cancelled (@(statusCounts.GetValueOrDefault("Cancelled", 0)))</option>
                                <option value="Pending">Pending (@(statusCounts.GetValueOrDefault("Pending", 0)))</option>
                            </select>
                        </div>

                        <div class="col-md-2">
                            <select id="roomTypeFilter" class="form-select">
                                <option value="all">All Room Types</option>
                                <option value="Single">Single Rooms</option>
                                <option value="Double">Double Rooms</option>
                                <option value="Suite">Luxury Suites</option>
                            </select>
                        </div>

                        <div class="col-md-2">
                            <select id="paymentStatusFilter" class="form-select">
                                <option value="all">All Payments</option>
                                <option value="Pending">Pending Payment (@pendingPaymentCount)</option>
                                <option value="Paid">Paid (@paidCount)</option>
                                <option value="Failed">Failed (@failedPaymentCount)</option>
                            </select>
                        </div>

                        <div class="col-md-2">
                            <select id="sortFilter" class="form-select">
                                <option value="newest">Newest First</option>
                                <option value="oldest">Oldest First</option>
                                <option value="amount-high">Amount (High to Low)</option>
                                <option value="amount-low">Amount (Low to High)</option>
                                <option value="guests">Guests (High to Low)</option>
                            </select>
                        </div>
                    </div>

                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="filter-buttons">
                                <button type="button" class="filter-btn active" data-filter="all">All (@Model.Count())</button>
                                <button type="button" class="filter-btn" data-filter="today">Today</button>
                                <button type="button" class="filter-btn" data-filter="week">This Week</button>
                                <button type="button" class="filter-btn" data-filter="month">This Month</button>
                                <button type="button" class="filter-btn" data-filter="pending-payment">Pending Payment (@pendingPaymentCount)</button>
                                <button type="button" class="filter-btn" data-filter="rated">Rated (@totalRatings)</button>
                                <button type="button" class="filter-btn" data-filter="feedback">With Feedback (@feedbackCount)</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="data-table-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="m-0 font-weight-bold">
                            <i class="fas fa-list me-2"></i>All Reservations
                            <small class="text-muted ms-2" id="resultsCount">(@Model.Count() total)</small>
                        </h5>
                        <div>
                            <span class="badge bg-primary me-2">Active: @totalReservations</span>
                            <span class="badge bg-danger me-2">Cancelled: @cancelledReservations</span>
                            <span class="badge bg-warning me-2">Pending Payment: @pendingPaymentCount</span>
                            <span class="badge bg-success">Paid: @paidCount</span>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div id="loadingIndicator" class="loading-state" style="display: none;">
                        <div class="loading-spinner"></div>
                        <span class="ms-2">Filtering reservations...</span>
                    </div>

                    <div id="reservationsContainer">
                        @if (Model.Any())
                        {
                            <div class="row" id="reservationsGrid">
                                @foreach (var item in Model)
                                {
                                    <div class="col-lg-6 col-xl-4 mb-4 reservation-item"
                                         data-status="@item.Status?.ToLower()"
                                         data-room-type="@item.RoomType"
                                         data-guest-name="@item.GuestName?.ToLower()"
                                         data-reservation-no="@item.ReservationNo?.ToLower()"
                                         data-room-number="@item.RoomNumber?.ToLower()"
                                         data-amount="@item.TotalAmount"
                                         data-guests="@item.NumberOfGuests"
                                         data-date="@item.CreatedDate.ToString("yyyy-MM-dd")"
                                         data-rating="@(item.Rating.HasValue ? "rated" : "not-rated")"
                                         data-feedback="@(!string.IsNullOrEmpty(item.Feedback) ? "has-feedback" : "no-feedback")"
                                         data-transaction-no="@item.TransactionNumber?.ToLower()"
                                         data-payment-status="@item.PaymentStatus?.ToLower()">
                                        <div class="card reservation-card h-100
                                                    @(item.Status == "Cancelled" ? "border-danger" :
                                                                                           item.Status == "Checked-In" ? "border-info" :
                                                                                           item.Status == "Completed" ? "border-success" : "border-primary")">
                                                                                                                                                           <div class="card-header">
                                                                                                                                                               <div class="d-flex justify-content-between align-items-center">
                                                                                                                                                                   <h6 class="mb-0">
                                                                                                                                                                       <span class="badge bg-primary">@item.ReservationNo</span>
                                                                                                                                                                   </h6>
                                                                                                                                                                   <div class="d-flex flex-column align-items-end">
                                                                                                                                                                       <span class="badge
                                                                    @(item.Status == "Confirmed" ? "bg-success" :
                                                                                                                            item.Status == "Cancelled" ? "bg-danger" :
                                                                                                                            item.Status == "Completed" ? "bg-info" :
                                                                                                                            item.Status == "Checked-In" ? "bg-primary" : "bg-warning") mb-1">
                                                                                                                                                                                    @item.Status
                                                                                                                                                                                </span>
                                                                                                                                                                                <span class="badge
                                                                    @(item.PaymentStatus == "Paid" ? "bg-success" :
                                                                                                                            item.PaymentStatus == "Pending" ? "bg-warning" : "bg-danger")">
                                                    @item.PaymentStatus
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <h6 class="card-title">@item.GuestName</h6>
                                            @if (!string.IsNullOrEmpty(item.UserId))
                                                    {
                                                        <small class="text-muted">User ID: @item.UserId.Substring(0, 8)...</small>
                                                    }
                                                </div>

                                                <div class="mb-3">
                                                    <small class="text-muted">Transaction Number</small>
                                                    <div>
                                                        @if (!string.IsNullOrEmpty(item.TransactionNumber))
                                                        {
                                                            <code class="text-primary">@item.TransactionNumber</code>
                                                        }
                                                        else
                                                        {
                                                            <span class="text-muted">Not generated</span>
                                                        }
                                                    </div>
                                                </div>

                                                @if (!string.IsNullOrEmpty(item.ReceiptNumber))
                                                {
                                                    <div class="mb-3">
                                                        <small class="text-muted">Payment Receipt No</small>
                                                        <div>
                                                            <span class="badge bg-success">@item.ReceiptNumber</span>
                                                        </div>
                                                    </div>
                                                }

                                                @if (!string.IsNullOrEmpty(item.ReferenceNumber))
                                                {
                                                    <div class="mb-3">
                                                        <small class="text-muted">Payment Reference</small>
                                                        <div>
                                                            <span class="badge bg-info">@item.ReferenceNumber</span>
                                                        </div>
                                                    </div>
                                                }

                                            <div class="row mb-3">
                                                <div class="col-6">
                                                    <small class="text-muted">Room Type</small>
                                                    <div>
                                                        <span class="badge
                                                                    @(item.RoomType == "Suite" ? "room-badge-suite" :
                                                                                                                                item.RoomType == "Double" ? "room-badge-double" : "room-badge-single")">
                                                        @item.RoomType
                                                    </span>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <small class="text-muted">Room Number</small>
                                                <div>
                                                    @if (!string.IsNullOrEmpty(item.RoomNumber))
                                                            {
                                                                <span class="badge bg-secondary">@item.RoomNumber</span>
                                                            }
                                                            else
                                                            {
                                                                <span class="text-muted">Not assigned</span>
                                                            }
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="row mb-3">
                                                    <div class="col-6">
                                                        <small class="text-muted">Check-in</small>
                                                        <div class="fw-bold">@(item.CheckInDate?.ToString("MMM dd, yyyy") ?? "Not set")</div>
                                                    </div>
                                                    <div class="col-6">
                                                        <small class="text-muted">Check-out</small>
                                                        <div class="fw-bold">@(item.CheckOutDate?.ToString("MMM dd, yyyy") ?? "Not set")</div>
                                                    </div>
                                                </div>

                                                <div class="row mb-3">
                                                    <div class="col-6">
                                                        <small class="text-muted">Guests</small>
                                                        <div>
                                                            <span class="badge bg-dark">@item.NumberOfGuests</span>
                                                        </div>
                                                    </div>
                                                    <div class="col-6">
                                                        <small class="text-muted">Payment</small>
                                                        <div>
                                                            <span class="badge bg-info">@item.PaymentMethod</span>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="mb-3">
                                                    <small class="text-muted">Total Amount</small>
                                                    <div class="fw-bold fs-5 @(item.Status == "Cancelled" ? "text-muted" : "text-success")">
                                                        ₱@item.TotalAmount.ToString("N2")
                                                    </div>
                                                </div>

                                                <div class="mb-3">
                                                    <small class="text-muted">Rating</small>
                                                    <div>
                                                        @if (item.Rating.HasValue)
                                                        {
                                                            <div class="rating-display">
                                                                @for (int i = 1; i <= 5; i++)
                                                                {
                                                                    <i class="fas fa-star @(i <= item.Rating ? "text-warning" : "text-muted")" style="font-size: 0.8rem;"></i>
                                                                }
                                                                <small class="ms-1">(@item.Rating.Value)/5</small>
                                                            </div>
                                                        }
                                                        else
                                                        {
                                                            <span class="text-muted">No rating</span>
                                                        }
                                                    </div>
                                                </div>

                                                <div class="action-buttons">
                                                    <div class="btn-group w-100" role="group">
                                                        <a asp-controller="Home" asp-action="Edit" asp-route-id="@item.ReservationId"
                                                           class="btn btn-outline-primary btn-sm" title="Edit">
                                                            <i class="fas fa-edit"></i>
                                                        </a>

                                                        @if (item.PaymentMethod == "Cash" && item.PaymentStatus == "Pending" && item.Status != "Cancelled")
                                                        {
                                                            <button type="button" class="btn btn-outline-success btn-sm confirm-cash-btn"
                                                                    title="Confirm Cash Payment"
                                                                    data-reservation-id="@item.ReservationId"
                                                                    data-reservation-no="@item.ReservationNo"
                                                                    data-amount="@item.TotalAmount">
                                                                <i class="fas fa-money-bill-wave"></i>
                                                            </button>
                                                        }

                                                        @if (item.PaymentMethod != "Cash" && item.PaymentStatus == "Pending" && item.Status != "Cancelled")
                                                        {
                                                            <button type="button" class="btn btn-outline-success btn-sm add-reference-btn"
                                                                    title="Add Reference & Confirm"
                                                                    data-reservation-id="@item.ReservationId"
                                                                    data-reservation-no="@item.ReservationNo"
                                                                    data-amount="@item.TotalAmount">
                                                                <i class="fas fa-check-circle"></i>
                                                            </button>
                                                        }

                                                        @if (item.Status == "Confirmed" && item.PaymentStatus == "Paid")
                                                        {
                                                            <form asp-controller="Home" asp-action="CheckInReservation" method="post" class="d-inline checkin-form" id="checkin-form-@item.ReservationId">
                                                                @Html.AntiForgeryToken()
                                                                <input type="hidden" name="reservationId" value="@item.ReservationId" />
                                                                <button type="button" class="btn btn-outline-info btn-sm checkin-btn"
                                                                        title="Check In"
                                                                        data-reservation-no="@item.ReservationNo"
                                                                        data-form-id="checkin-form-@item.ReservationId">
                                                                    <i class="fas fa-sign-in-alt"></i>
                                                                </button>
                                                            </form>
                                                        }

                                                        @if (item.Status == "Checked-In")
                                                        {
                                                            <form asp-controller="Home" asp-action="CompleteReservationEarly" method="post" class="d-inline complete-form" id="complete-form-@item.ReservationId">
                                                                @Html.AntiForgeryToken()
                                                                <input type="hidden" name="reservationId" value="@item.ReservationId" />
                                                                <button type="button" class="btn btn-outline-success btn-sm complete-btn"
                                                                        title="Complete Early"
                                                                        data-reservation-no="@item.ReservationNo"
                                                                        data-form-id="complete-form-@item.ReservationId">
                                                                    <i class="fas fa-sign-out-alt"></i>
                                                                </button>
                                                            </form>
                                                        }

                                                        @if (!string.IsNullOrEmpty(item.Feedback))
                                                        {
                                                            <button type="button" class="btn btn-outline-warning btn-sm view-feedback-btn"
                                                                    title="View Feedback"
                                                                    data-guest-name="@item.GuestName"
                                                                    data-rating="@item.Rating"
                                                                    data-feedback="@item.Feedback"
                                                                    data-room-type="@item.RoomType">
                                                                <i class="fas fa-comment"></i>
                                                            </button>
                                                        }

                                                        <form asp-controller="Home" asp-action="Delete" asp-route-id="@item.ReservationId" method="post" class="d-inline delete-form" id="delete-form-@item.ReservationId">
                                                            @Html.AntiForgeryToken()
                                                            <button type="button" class="btn btn-outline-danger btn-sm delete-btn"
                                                                    title="Delete"
                                                                    data-reservation-no="@item.ReservationNo"
                                                                    data-form-id="delete-form-@item.ReservationId">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="empty-state">
                                <i class="fas fa-calendar-times empty-state-icon"></i>
                                <h4>No Reservations Found</h4>
                                <p>There are no reservations in the system yet.</p>
                                <a href="@Url.Action("Create", "Home")" class="btn btn-primary btn-lg">
                                    <i class="fas fa-plus-circle me-1"></i>Create First Reservation
                                </a>
                            </div>
                        }
                    </div>

                    <div id="noResults" class="empty-state" style="display: none;">
                        <i class="fas fa-search empty-state-icon"></i>
                        <h4>No Matching Reservations</h4>
                        <p>No reservations match your current search and filter criteria.</p>
                        <button class="btn btn-primary" onclick="clearAllFilters()">
                            <i class="fas fa-times me-1"></i>Clear All Filters
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="cashPaymentModal" tabindex="-1" aria-labelledby="cashPaymentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="cashPaymentModalLabel">
                    <i class="fas fa-money-bill-wave me-2"></i>Confirm Cash Payment
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form asp-controller="Home" asp-action="ConfirmCashPayment" method="post" id="cashPaymentForm">
                @Html.AntiForgeryToken()
                <div class="modal-body">
                    <input type="hidden" name="reservationId" id="cashReservationId" />

                    <div class="alert alert-warning border-warning">
                        <h6><i class="fas fa-exclamation-triangle me-2"></i><strong>VERIFY CASH BEFORE PROCEEDING</strong></h6>
                        <p class="mb-0">Ensure you have <strong>physically received the exact cash amount</strong> before issuing receipt.</p>
                    </div>

                    <div class="payment-details mb-3 p-3 border border-success rounded bg-light">
                        <div class="row text-center">
                            <div class="col-12 mb-2">
                                <strong class="text-primary">Reservation No:</strong>
                                <div id="cashReservationNo" class="fw-bold fs-5 text-primary"></div>
                            </div>
                            <div class="col-12">
                                <strong class="text-success">Cash Amount Received:</strong>
                                <div id="cashAmount" class="fw-bold fs-4 text-success"></div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="receiptNumber" class="form-label">
                            <strong>Official Receipt Number <span class="text-danger">*</span></strong>
                        </label>
                        <input type="text" class="form-control" id="receiptNumber" name="receiptNumber"
                               placeholder="Enter OR Number (e.g., OR-001)" required
                               pattern="[A-Za-z0-9-]+" title="Enter a valid receipt number">
                        <small class="form-text text-muted">Official receipt number issued to customer</small>
                    </div>

                    <div class="cash-verification">
                        <label class="form-label fw-bold">Cash Verification:</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="cashVerified" required>
                            <label class="form-check-label" for="cashVerified">
                                I confirm that I have received the exact cash amount and issued the official receipt
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success" id="confirmCashBtn" disabled>
                        <i class="fas fa-check-circle me-1"></i>Confirm Cash Received
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="referenceModal" tabindex="-1" aria-labelledby="referenceModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="referenceModalLabel">
                    <i class="fas fa-credit-card me-2"></i>Add Payment Reference
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form asp-controller="Home" asp-action="ConfirmPaymentWithReference" method="post" id="referenceForm">
                @Html.AntiForgeryToken()
                <div class="modal-body">
                    <input type="hidden" name="reservationId" id="referenceReservationId" />

                    <div class="payment-details mb-3 p-3 border border-info rounded bg-light">
                        <div class="row text-center">
                            <div class="col-12 mb-2">
                                <strong class="text-primary">Reservation No:</strong>
                                <div id="referenceReservationNo" class="fw-bold fs-5 text-primary"></div>
                            </div>
                            <div class="col-12">
                                <strong class="text-success">Payment Amount:</strong>
                                <div id="referenceAmount" class="fw-bold fs-4 text-success"></div>
                            </div>
                        </div>
                    </div>

                  

                    <div class="mb-3">
                        <label for="referenceNumber" class="form-label">
                            <strong>Reference Number <span class="text-danger">*</span></strong>
                        </label>
                        <input type="text" class="form-control" id="referenceNumber" name="referenceNumber"
                               placeholder="Enter payment reference number" required>
                        <small class="form-text text-muted">Unique reference number from payment provider</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-info">
                        <i class="fas fa-save me-1"></i>Confirm Payment
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="feedbackViewModal" tabindex="-1" aria-labelledby="feedbackViewModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="feedbackViewModalLabel">
                    <i class="fas fa-comment me-2"></i>Guest Feedback
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <h6 id="feedbackGuestName" class="text-primary"></h6>
                    <small id="feedbackRoomType" class="text-muted"></small>
                </div>

                <div class="rating-display text-center mb-3">
                    <div id="feedbackRatingStars"></div>
                    <small class="text-muted" id="feedbackRatingText"></small>
                </div>

                <div class="feedback-content">
                    <label class="form-label fw-bold">Feedback:</label>
                    <div class="card bg-light">
                        <div class="card-body">
                            <p id="feedbackContent" class="mb-0" style="font-style: italic;"></p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        $(document).ready(function() {
            let filterTimeout;

            $('#searchInput').on('input', function() {
                clearTimeout(filterTimeout);
                filterTimeout = setTimeout(filterReservations, 300);
            });

            $('#clearSearch').on('click', function() {
                $('#searchInput').val('');
                filterReservations();
            });

            $('#statusFilter, #roomTypeFilter, #paymentStatusFilter, #sortFilter').on('change', filterReservations);

            $('.filter-btn').on('click', function() {
                $('.filter-btn').removeClass('active');
                $(this).addClass('active');
                filterReservations();
            });

            function filterReservations() {
                const searchTerm = $('#searchInput').val().toLowerCase().trim();
                const statusFilter = $('#statusFilter').val();
                const roomTypeFilter = $('#roomTypeFilter').val();
                const paymentStatusFilter = $('#paymentStatusFilter').val();
                const sortFilter = $('#sortFilter').val();
                const timeFilter = $('.filter-btn.active').data('filter');

                $('#loadingIndicator').show();
                $('#reservationsGrid').hide();

                setTimeout(() => {
                    let visibleCount = 0;

                    $('.reservation-item').each(function() {
                        const $item = $(this);

                        const guestName = String($item.data('guest-name') || '');
                        const reservationNo = String($item.data('reservation-no') || '');
                        const roomNumber = String($item.data('room-number') || '');
                        const status = String($item.data('status') || '');
                        const roomType = String($item.data('room-type') || '');
                        const paymentStatus = String($item.data('payment-status') || '');
                        const amount = parseFloat($item.data('amount')) || 0;
                        const guests = parseInt($item.data('guests')) || 0;
                        const date = String($item.data('date') || '');
                        const hasRating = $item.data('rating') === 'rated';
                        const hasFeedback = $item.data('feedback') === 'has-feedback';
                         const transactionNo = String($item.data('transaction-no') || '');

                        const matchesSearch = searchTerm === '' ||
                            guestName.includes(searchTerm) ||
                            reservationNo.includes(searchTerm) ||
                            roomNumber.includes(searchTerm)||
                            transactionNo.includes(searchTerm);

                        const matchesStatus = statusFilter === 'all' ||
                            status === statusFilter.toLowerCase();

                        const matchesRoomType = roomTypeFilter === 'all' ||
                            roomType === roomTypeFilter;

                        const matchesPaymentStatus = paymentStatusFilter === 'all' ||
                            paymentStatus === paymentStatusFilter.toLowerCase();

                        let matchesTime = true;
                        if (timeFilter && timeFilter !== 'all') {
                            const itemDate = new Date(date);
                            const today = new Date();

                            switch (timeFilter) {
                                case 'today':
                                    matchesTime = itemDate.toDateString() === today.toDateString();
                                    break;
                                case 'week':
                                    const startOfWeek = new Date(today);
                                    startOfWeek.setDate(today.getDate() - today.getDay());
                                    startOfWeek.setHours(0, 0, 0, 0);
                                    matchesTime = itemDate >= startOfWeek;
                                    break;
                                case 'month':
                                    matchesTime = itemDate.getMonth() === today.getMonth() &&
                                                itemDate.getFullYear() === today.getFullYear();
                                    break;
                                case 'pending-payment':
                                    matchesTime = paymentStatus === 'pending';
                                    break;
                                case 'rated':
                                    matchesTime = hasRating;
                                    break;
                                case 'feedback':
                                    matchesTime = hasFeedback;
                                    break;
                                default:
                                    matchesTime = true;
                            }
                        }

                        const isVisible = matchesSearch && matchesStatus && matchesRoomType && matchesPaymentStatus && matchesTime;
                        $item.toggle(isVisible);
                        if (isVisible) visibleCount++;
                    });

                    sortReservations(sortFilter);

                    $('#resultsCount').text(`(${visibleCount} results)`);

                    if (visibleCount === 0) {
                        $('#noResults').show();
                        $('#reservationsGrid').hide();
                    } else {
                        $('#noResults').hide();
                        $('#reservationsGrid').show();
                    }

                    $('#loadingIndicator').hide();
                }, 500);
            }

            function sortReservations(sortType) {
                const $container = $('#reservationsGrid');
                const $items = $('.reservation-item:visible').get();

                $items.sort(function(a, b) {
                    const $a = $(a);
                    const $b = $(b);

                    switch (sortType) {
                        case 'oldest':
                            return new Date($a.data('date')) - new Date($b.data('date'));
                        case 'amount-high':
                            return parseFloat($b.data('amount')) - parseFloat($a.data('amount'));
                        case 'amount-low':
                            return parseFloat($a.data('amount')) - parseFloat($b.data('amount'));
                        case 'guests':
                            return parseInt($b.data('guests')) - parseInt($a.data('guests'));
                        case 'newest':
                        default:
                            return new Date($b.data('date')) - new Date($a.data('date'));
                    }
                });

                $.each($items, function(i, item) {
                    $container.append(item);
                });
            }

            function clearAllFilters() {
                $('#searchInput').val('');
                $('#statusFilter').val('all');
                $('#roomTypeFilter').val('all');
                $('#paymentStatusFilter').val('all');
                $('#sortFilter').val('newest');
                $('.filter-btn').removeClass('active');
                $('.filter-btn[data-filter="all"]').addClass('active');
                filterReservations();
            }

            $(document).on('click', '.confirm-cash-btn', function(e) {
                e.preventDefault();
                const reservationId = $(this).data('reservation-id');
                const reservationNo = $(this).data('reservation-no');
                const amount = $(this).data('amount');

                $('#cashReservationId').val(reservationId);
                $('#cashReservationNo').text(reservationNo);
                $('#cashAmount').text('₱' + parseFloat(amount).toLocaleString('en-US', {minimumFractionDigits: 2}));
                $('#receiptNumber').val('');
                $('#cashVerified').prop('checked', false);
                $('#confirmCashBtn').prop('disabled', true);

                $('#cashPaymentModal').modal('show');
            });

            $('#cashVerified').change(function() {
                $('#confirmCashBtn').prop('disabled', !this.checked);
            });

            $(document).on('click', '.add-reference-btn', function(e) {
                e.preventDefault();
                const reservationId = $(this).data('reservation-id');
                const reservationNo = $(this).data('reservation-no');
                const amount = $(this).data('amount');

                $('#referenceReservationId').val(reservationId);
                $('#referenceReservationNo').text(reservationNo);
                $('#referenceAmount').text('₱' + parseFloat(amount).toLocaleString('en-US', {minimumFractionDigits: 2}));
                $('#paymentProvider').val('');
                $('#referenceNumber').val('');

                $('#referenceModal').modal('show');
            });

            $(document).on('click', '.checkin-btn', function(e) {
                e.preventDefault();
                const reservationNo = $(this).data('reservation-no');
                const formId = $(this).data('form-id');
                const form = document.getElementById(formId);

                Swal.fire({
                    title: 'Check In Reservation?',
                    text: `Are you sure you want to check in reservation ${reservationNo}?`,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Yes, Check In',
                    cancelButtonText: 'Cancel',
                    background: '#1a1a1a',
                    color: '#ffffff'
                }).then((result) => {
                    if (result.isConfirmed) {
                        form.submit();
                    }
                });
            });

            $(document).on('click', '.complete-btn', function(e) {
                e.preventDefault();
                const reservationNo = $(this).data('reservation-no');
                const formId = $(this).data('form-id');
                const form = document.getElementById(formId);

                Swal.fire({
                    title: 'Complete Reservation Early?',
                    text: `Are you sure you want to complete reservation ${reservationNo} early? The room will be marked as available.`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#28a745',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Yes, Complete',
                    cancelButtonText: 'Cancel',
                    background: '#1a1a1a',
                    color: '#ffffff'
                }).then((result) => {
                    if (result.isConfirmed) {
                        form.submit();
                    }
                });
            });

            $(document).on('click', '.view-feedback-btn', function(e) {
                e.preventDefault();
                const guestName = $(this).data('guest-name');
                const rating = $(this).data('rating');
                const feedback = $(this).data('feedback');
                const roomType = $(this).data('room-type');

                $('#feedbackGuestName').text(guestName);
                $('#feedbackRoomType').text(roomType + ' Room');
                $('#feedbackContent').text(feedback);

                let starsHtml = '';
                for (let i = 1; i <= 5; i++) {
                    starsHtml += `<i class="fas fa-star ${i <= rating ? 'text-warning' : 'text-muted'}" style="font-size: 1.2rem;"></i>`;
                }
                $('#feedbackRatingStars').html(starsHtml);
                $('#feedbackRatingText').text(`(${rating}/5)`);

                $('#feedbackViewModal').modal('show');
            });

            $(document).on('click', '.delete-btn', function(e) {
                e.preventDefault();
                const reservationNo = $(this).data('reservation-no');
                const formId = $(this).data('form-id');
                const form = document.getElementById(formId);

                Swal.fire({
                    title: 'Delete Reservation?',
                    text: `Are you sure you want to permanently delete reservation ${reservationNo}? This action cannot be undone.`,
                    icon: 'error',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Yes, Delete',
                    cancelButtonText: 'Cancel',
                    background: '#1a1a1a',
                    color: '#ffffff'
                }).then((result) => {
                    if (result.isConfirmed) {
                        form.submit();
                    }
                });
            });

            setTimeout(function() {
                $('.alert').fadeOut('slow');
            }, 5000);
        });

        function refreshDashboard() {
            location.reload();
        }
    </script>
}

<style>
    .room-status-overview {
        background: linear-gradient(135deg, #f8f9fc 0%, #e3e6f0 100%);
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }

    .status-card {
        padding: 1.5rem;
        border-radius: 12px;
        background: white;
        text-align: center;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        border: 2px solid transparent;
        position: relative;
        overflow: hidden;
    }

        .status-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--status-color), transparent);
        }

        .status-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

    .status-value {
        font-size: 2.5rem;
        font-weight: 800;
        margin-bottom: 0.5rem;
        background: linear-gradient(135deg, var(--status-color), var(--status-dark));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .status-label {
        font-size: 0.9rem;
        color: #2c3e50;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.5rem;
    }

    .status-card .text-success {
        --status-color: #1cc88a;
        --status-dark: #13855c;
    }

    .status-card .text-primary {
        --status-color: #4e73df;
        --status-dark: #224abe;
    }

    .status-card .text-warning {
        --status-color: #f6c23e;
        --status-dark: #dda20a;
    }

    .status-card .text-danger {
        --status-color: #e74a3b;
        --status-dark: #be2617;
    }

    .filter-buttons {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        justify-content: center;
    }

    .filter-btn {
        padding: 0.75rem 1.5rem;
        border: 2px solid #e9ecef;
        background: white;
        color: #6c757d;
        border-radius: 25px;
        font-weight: 600;
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }

        .filter-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }

        .filter-btn:hover::before {
            left: 100%;
        }

        .filter-btn:hover,
        .filter-btn.active {
            background: linear-gradient(135deg, #4e73df, #224abe);
            color: white;
            border-color: #4e73df;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(78, 115, 223, 0.3);
        }
</style>